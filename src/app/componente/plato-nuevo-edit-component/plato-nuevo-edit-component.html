<div class="plate-editor-container">

  <mat-card class="main-card">
    <div class="layout-grid">

      <!-- COLUMNA IZQUIERDA: Resumen Total (Contexto) -->
      <div class="panel-info">
        <div class="plate-header-preview">
          <span class="badge">Resumen Nutricional</span>
          <!-- Muestra el nombre que escribes en el form o un placeholder -->
          <h2>{{ platoForm.get('nombre')?.value || 'Nuevo Plato' }}</h2>
          <p class="subtitle">{{ platoForm.get('informacion')?.value || 'Sin descripción aún...' }}</p>
        </div>

        <!-- EL GRAN TOTAL (Cálculo en vivo) -->
        <div class="total-summary">
          <div class="big-number">
            <span class="lbl">Total Calorías</span>
            <span class="val">{{ calcularTotalCalorias() | number:'1.0-0' }}</span>
            <span class="unit">kcal</span>
          </div>

          <div class="macros-breakdown">
            <div class="macro-row p">
              <div class="macro-icon"><mat-icon>fitness_center</mat-icon></div>
              <div class="macro-data">
                <span class="label">Proteínas</span>
                <span class="value">{{ calcularTotalProteina() | number:'1.0-1' }}g</span>
              </div>
            </div>
            <div class="macro-row c">
              <div class="macro-icon"><mat-icon>grain</mat-icon></div>
              <div class="macro-data">
                <span class="label">Carbohidratos</span>
                <span class="value">{{ calcularTotalCarbos() | number:'1.0-1' }}g</span>
              </div>
            </div>
            <div class="macro-row f">
              <div class="macro-icon"><mat-icon>water_drop</mat-icon></div>
              <div class="macro-data">
                <span class="label">Grasas</span>
                <span class="value">{{ calcularTotalGrasas() | number:'1.0-1' }}g</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Decoración -->
        <div class="bg-decoration">
          <mat-icon>dinner_dining</mat-icon>
        </div>
      </div>

      <!-- COLUMNA DERECHA: Constructor (Acción) -->
      <div class="panel-action">

        <div class="action-header">
          <h3>{{ edicion ? 'Editar Receta' : 'Agregar Nuevo Plato' }}</h3>
        </div>

        <form [formGroup]="platoForm" (ngSubmit)="onSubmit()" class="builder-form">

          <!-- 1. Datos Básicos -->
          <div class="basic-inputs">
            <mat-form-field appearance="outline" class="w-100">
              <mat-label>Nombre del Plato</mat-label>
              <input matInput formControlName="nombre" placeholder="Ej: Pollo con Arroz">
            </mat-form-field>

            <mat-form-field appearance="outline" class="w-100">
              <mat-label>Descripción / Notas</mat-label>
              <textarea matInput formControlName="informacion" rows="1" placeholder="Ej: Plato post-entreno..."></textarea>
            </mat-form-field>
          </div>

          <div class="separator"></div>

          <!-- 2. Constructor de Ingredientes -->
          <div class="ingredients-builder">
            <h4><mat-icon>playlist_add</mat-icon> Agregar Ingredientes</h4>

            <div class="add-row">
              <mat-form-field appearance="outline" class="select-food">
                <mat-label>Buscar Alimento</mat-label>
                <mat-select [(ngModel)]="alimentoSeleccionado" [ngModelOptions]="{standalone: true}">
                  <mat-option *ngFor="let item of alimentosDisponibles" [value]="item.id">
                    {{ item.nombre }} ({{ item.calorias }} kcal)
                  </mat-option>
                </mat-select>
              </mat-form-field>

              <mat-form-field appearance="outline" class="input-qty">
                <mat-label>Gramos</mat-label>
                <input matInput type="number" [(ngModel)]="cantidadAlimento" [ngModelOptions]="{standalone: true}" min="1" placeholder="100">
                <span matSuffix>g</span>
              </mat-form-field>

              <button type="button" mat-mini-fab color="primary" (click)="agregarAlimento()"
                      [disabled]="!alimentoSeleccionado || cantidadAlimento <= 0"
                      class="btn-add">
                <mat-icon>add</mat-icon>
              </button>
            </div>
          </div>

          <!-- 3. Lista de Ingredientes (Tabla) -->
          <div class="ingredients-list-wrapper" *ngIf="dataSource.data.length > 0">
            <table mat-table [dataSource]="dataSource" class="clean-table">

              <!-- Alimento -->
              <ng-container matColumnDef="nombre">
                <th mat-header-cell *matHeaderCellDef>Ingrediente</th>
                <td mat-cell *matCellDef="let element">
                  <span class="fw-bold">{{ element.alimento.nombre }}</span>
                  <span class="sub-text">{{ element.alimento.categoriaNombre }}</span>
                </td>
              </ng-container>

              <!-- Cantidad -->
              <ng-container matColumnDef="cantidad">
                <th mat-header-cell *matHeaderCellDef>Cant.</th>
                <td mat-cell *matCellDef="let element">{{ element.cantidad }}g</td>
              </ng-container>

              <!-- Calorias -->
              <ng-container matColumnDef="calorias">
                <th mat-header-cell *matHeaderCellDef>Kcal</th>
                <td mat-cell *matCellDef="let element" class="fw-bold text-primary">
                  {{ (element.alimento.calorias * element.cantidad / 100) | number:'1.0-0' }}
                </td>
              </ng-container>

              <!-- Acciones -->
              <ng-container matColumnDef="acciones">
                <th mat-header-cell *matHeaderCellDef></th>
                <td mat-cell *matCellDef="let element; let i = index" class="text-right">
                  <button type="button" mat-icon-button color="warn" (click)="eliminarAlimento(i)">
                    <mat-icon>close</mat-icon>
                  </button>
                </td>
              </ng-container>

              <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
              <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
            </table>
          </div>

          <!-- Estado Vacío -->
          <div class="empty-state" *ngIf="dataSource.data.length === 0">
            <p>Aún no hay ingredientes. ¡Agrega el primero arriba!</p>
          </div>

          <!-- Botones Finales -->
          <div class="form-actions">
            <button type="button" mat-button (click)="router.navigate(['/Plato'])">Cancelar</button>
            <button type="submit" mat-raised-button color="primary" [disabled]="!platoForm.valid || dataSource.data.length === 0">
              <mat-icon>save</mat-icon>
              {{ edicion ? 'Guardar Cambios' : 'Crear Plato' }}
            </button>
          </div>

        </form>
      </div>
    </div>
  </mat-card>
</div>
