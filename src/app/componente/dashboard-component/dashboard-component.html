<div class="dashboard-page">
  <mat-card class="dashboard-card">
    <div class="dashboard-content">

      <div class="panel-left">
        <div class="welcome-section">
          <h1>Hola, {{ nombreUsuario }}</h1>

          <div class="goal-group">
            <p class="motivation-text">{{ pesoMensaje }}</p>
          </div>

          <div class="weight-cards-container">
            <div class="weight-box current">
              <span class="w-label">PESO ACTUAL</span>
              <span class="w-value">{{ pesoActual | number:'1.0-1' }} <small>kg</small></span>
            </div>
            <div class="weight-box target">
              <span class="w-label">PESO IDEAL</span>
              <span class="w-value">{{ pesoIdeal | number:'1.0-1' }} <small>kg</small></span>
            </div>
          </div>
        </div>

        <div class="imc-section">
          <span class="imc-label">Tu IMC:</span>
          <div class="imc-number">{{ imc | number:'1.2-2' }}</div>
        </div>
      </div>

      <div class="vertical-separator"></div>

      <div class="panel-right">

        <div class="calories-header">
          <span class="cal-label">INGESTA DIARIA OBJETIVO</span>
          <div class="cal-value">
            {{ totalCalorias | number:'1.0-0' }} <span>Kcal</span>
          </div>
        </div>

        <div class="macros-container">

          <div class="macros-list">
            <div class="macro-item" *ngFor="let m of macros">
              <div class="macro-indicator" [style.background-color]="m.color"></div>
              <div class="macro-details">
                <span class="macro-name">{{ m.label }}</span>
                <span class="macro-val">
                  {{ m.value | number:'1.0-1' }}g
                  <small class="pct">({{ m.percent | number:'1.0-0' }}%)</small>
                </span>
              </div>
            </div>

            <div class="objective-info">
              <span class="obj-label">Objetivo:</span>
              <span class="obj-val">{{ objetivo.nombre || 'Cargando...' }}</span>
            </div>
          </div>

          <div class="chart-wrapper">
            <div class="donut-chart" [style.background]="macroPieGradient">
              <div class="center-white"></div>
            </div>
          </div>
        </div>

      </div>

    </div>
  </mat-card>

  <!-- Nueva sección: Progreso Nutricional del Día -->
  <mat-card class="progreso-card">
    <h2>Progreso Nutricional de Hoy</h2>

    <!-- Loading -->
    <div *ngIf="cargandoProgreso" class="loading-progreso">
      <mat-icon class="spinner">refresh</mat-icon>
      <p>Cargando progreso...</p>
    </div>

    <!-- Error -->
    <div *ngIf="errorProgreso && !cargandoProgreso" class="error-progreso">
      <mat-icon>info</mat-icon>
      <p>{{ errorProgreso }}</p>
    </div>

    <!-- Contenido del Progreso -->
    <div *ngIf="progresoNutricional && !cargandoProgreso" class="progreso-content">

      <!-- Estado General -->
      <div class="estado-general" [style.border-color]="getEstadoColor()">
        <mat-icon [style.color]="getEstadoColor()">{{ getEstadoIcono() }}</mat-icon>
        <div class="estado-info">
          <h3>{{ progresoNutricional.estado === 'EN_META' ? '¡En Meta!' : progresoNutricional.estado === 'DEFICIT' ? 'En Déficit' : 'En Exceso' }}</h3>
          <p>{{ progresoNutricional.mensaje }}</p>
        </div>
      </div>

      <!-- Resumen de Calorías -->
      <div class="calorias-resumen">
        <div class="calorias-item objetivo">
          <span class="label">Objetivo</span>
          <span class="valor">{{ progresoNutricional.objetivoCalorias | number:'1.0-0' }}</span>
          <span class="unidad">kcal</span>
        </div>
        <mat-icon>arrow_forward</mat-icon>
        <div class="calorias-item consumido">
          <span class="label">Consumido</span>
          <span class="valor">{{ progresoNutricional.consumidoCalorias | number:'1.0-0' }}</span>
          <span class="unidad">kcal</span>
        </div>
        <mat-icon>arrow_forward</mat-icon>
        <div class="calorias-item restante" [class.exceso]="progresoNutricional.restanteCalorias < 0">
          <span class="label">{{ progresoNutricional.restanteCalorias >= 0 ? 'Restante' : 'Excedido' }}</span>
          <span class="valor">{{ Math.abs(progresoNutricional.restanteCalorias) | number:'1.0-0' }}</span>
          <span class="unidad">kcal</span>
        </div>
      </div>

      <!-- Barras de Progreso -->
      <div class="barras-progreso">
        <!-- Proteínas -->
        <div class="barra-item">
          <div class="barra-header">
            <span class="barra-label">
              <mat-icon>fitness_center</mat-icon>
              Proteínas
            </span>
            <span class="barra-valores">
              {{ progresoNutricional.consumidoProteina | number:'1.0-1' }}g /
              {{ progresoNutricional.objetivoProteina | number:'1.0-1' }}g
              ({{ progresoNutricional.porcentajeProteina | number:'1.0-0' }}%)
            </span>
          </div>
          <div class="barra-progreso-container">
            <div class="barra-fill proteina" [style.width.%]="Math.min(progresoNutricional.porcentajeProteina, 100)"></div>
          </div>
        </div>

        <!-- Carbohidratos -->
        <div class="barra-item">
          <div class="barra-header">
            <span class="barra-label">
              <mat-icon>grain</mat-icon>
              Carbohidratos
            </span>
            <span class="barra-valores">
              {{ progresoNutricional.consumidoCarbohidrato | number:'1.0-1' }}g /
              {{ progresoNutricional.objetivoCarbohidrato | number:'1.0-1' }}g
              ({{ progresoNutricional.porcentajeCarbohidrato | number:'1.0-0' }}%)
            </span>
          </div>
          <div class="barra-progreso-container">
            <div class="barra-fill carbohidrato" [style.width.%]="Math.min(progresoNutricional.porcentajeCarbohidrato, 100)"></div>
          </div>
        </div>

        <!-- Grasas -->
        <div class="barra-item">
          <div class="barra-header">
            <span class="barra-label">
              <mat-icon>water_drop</mat-icon>
              Grasas
            </span>
            <span class="barra-valores">
              {{ progresoNutricional.consumidoGrasa | number:'1.0-1' }}g /
              {{ progresoNutricional.objetivoGrasa | number:'1.0-1' }}g
              ({{ progresoNutricional.porcentajeGrasa | number:'1.0-0' }}%)
            </span>
          </div>
          <div class="barra-progreso-container">
            <div class="barra-fill grasa" [style.width.%]="Math.min(progresoNutricional.porcentajeGrasa, 100)"></div>
          </div>
        </div>
      </div>

      <!-- Gráfico de Macros Consumidos -->
      <div class="macros-consumidos-section" *ngIf="macrosConsumidos.length > 0">
        <h3>Distribución de Macros Consumidos</h3>
        <div class="macros-consumidos-container">
          <div class="macros-consumidos-list">
            <div class="macro-consumido-item" *ngFor="let m of macrosConsumidos">
              <div class="macro-consumido-indicator" [style.background-color]="m.color"></div>
              <div class="macro-consumido-details">
                <span class="macro-consumido-name">{{ m.label }}</span>
                <span class="macro-consumido-val">
                  {{ m.value | number:'1.0-1' }}g
                  <small class="pct">({{ m.percent | number:'1.0-0' }}%)</small>
                </span>
              </div>
            </div>
          </div>

          <div class="chart-wrapper-small">
            <div class="donut-chart-small" [style.background]="macrosConsumidosGradient">
              <div class="center-white-small"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Alimentos Consumidos Hoy (Individual) -->
      <div class="alimentos-consumidos-section" *ngIf="alimentosIndividuales.length > 0">
        <h3>Alimentos Consumidos Hoy ({{ alimentosIndividuales.length }})</h3>
        <div class="alimentos-lista">
          <div class="alimento-consumido-card" *ngFor="let consumo of alimentosIndividuales">
            <div class="alimento-consumido-header">
              <mat-icon>restaurant</mat-icon>
              <strong>{{ consumo.alimentoNombre }}</strong>
              <span class="hora">{{ consumo.horaConsumo }}</span>
            </div>
            <div class="alimento-consumido-detalles">
              <span>{{ consumo.cantidad }} {{ consumo.unidad }}</span>
              <span class="separador">•</span>
              <span class="calorias">{{ consumo.caloriasCalculadas | number:'1.0-0' }} kcal</span>
            </div>
            <div class="alimento-consumido-nota" *ngIf="consumo.nota">
              <mat-icon>notes</mat-icon>
              <em>{{ consumo.nota }}</em>
            </div>
          </div>
        </div>
      </div>

      <!-- Platos Consumidos Hoy -->
      <div class="platos-consumidos-section" *ngIf="platosConAlimentos.length > 0">
        <h3>Platos Consumidos Hoy ({{ platosConAlimentos.length }})</h3>
        <div class="platos-lista">
          <div class="plato-consumido-card" *ngFor="let plato of platosConAlimentos">
            <div class="plato-consumido-header">
              <mat-icon>set_meal</mat-icon>
              <strong>{{ plato.nombre }}</strong>
              <span class="hora">{{ plato.horaConsumo }}</span>
              <span class="total-calorias">{{ plato.totalCalorias | number:'1.0-0' }} kcal</span>
            </div>
            <div class="alimentos-del-plato">
              <div class="alimento-del-plato" *ngFor="let alimento of plato.alimentos">
                <mat-icon>fiber_manual_record</mat-icon>
                <span class="alimento-nombre">{{ alimento.alimentoNombre }}</span>
                <span class="alimento-cantidad">{{ alimento.cantidad }} {{ alimento.unidad }}</span>
                <span class="alimento-calorias">{{ alimento.caloriasCalculadas | number:'1.0-0' }} kcal</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Mensaje sin consumos -->
      <div class="sin-consumos" *ngIf="!resumenDiario || resumenDiario.cantidadComidas === 0">
        <mat-icon>info</mat-icon>
        <p>Aún no has registrado ningún alimento hoy</p>
        <button mat-raised-button color="primary" routerLink="/alimentos">
          <mat-icon>add</mat-icon>
          Registrar Primer Alimento
        </button>
      </div>

    </div>
  </mat-card>
</div>
